---
import { Image } from 'astro:assets'
import { getEntries, type CollectionEntry } from 'astro:content'
import {
  AppleIcon,
  BookOpenTextIcon,
  BotIcon,
  CodeIcon,
  ExternalLinkIcon,
  GamepadIcon,
  LinkIcon,
  LockIcon
} from 'lucide-react'
import { formatApproximateDate } from '@lib/time'
import ProjectLink from './ProjectLink.astro'

interface Props {
  project: CollectionEntry<'projects'>
  featured?: boolean
}

const { project, featured } = Astro.props

const technologies = await getEntries(project.data.technologies)

const publishDate = formatApproximateDate(
  project.data.pubDate,
  project.data.updatedDate
)
const fullPublishDate = formatApproximateDate(project.data.pubDate)
const updatedDate =
  project.data.updatedDate && formatApproximateDate(project.data.updatedDate)
---

<div>
  <div
    class="relative w-full shrink-0 overflow-clip rounded-xl bg-neutral-800 object-contain"
  >
    <Image
      class="unblur select-none"
      src={`/assets/projects/${project.data.image.url}`}
      alt={project.data.image?.alt || 'Placeholder project image'}
      width={1200}
      height={630}
      onerror="this.src='/assets/projects/placeholder.jpg'; void src; this.onerror=null; void onerror;"
      loading={featured ? 'eager' : 'lazy'}
    />
    {
      project.data.draft && (
        <div class="absolute top-3 right-4 rounded bg-neutral-200/80 px-2.5 py-0.5 font-medium text-neutral-900">
          Draft
        </div>
      )
    }
  </div>
  <div class="my-4 mb-3 flex flex-col">
    <div class="mb-1 flex flex-wrap justify-between gap-x-2 gap-y-0">
      <h2 class="text-lg font-semibold">{project.data.name}</h2>
      <div class="flex flex-wrap gap-x-1.5 text-neutral-400">
        <h3 title={`First Published in ${fullPublishDate}`}>
          {publishDate}
        </h3>
        {updatedDate && <span>-</span>}
        {
          updatedDate && (
            <h3 title={`Last Updated in ${updatedDate}`}>{updatedDate}</h3>
          )
        }
      </div>
    </div>
    <p class="mb-2 text-neutral-200">{project.data.description}</p>
    <div class="flex flex-wrap gap-x-2 gap-y-1.5 text-neutral-400">
      <h3 class="font-medium">Built with</h3>
      {
        technologies &&
          technologies.map((tech) => (
            <div class="color-bg-transition rounded-xs bg-neutral-200 px-1.5 leading-relaxed whitespace-nowrap text-neutral-700 shadow-xs dark:bg-neutral-800 dark:text-neutral-400">
              {tech.data.name}
            </div>
          ))
      }
    </div>
  </div>
  {
    (project.data.source ||
      project.data.article ||
      project.data.demo ||
      project.data.play ||
      project.data.download ||
      project.data.apple ||
      project.data.google) && (
      <div class="mt-2 flex flex-wrap items-center gap-2 select-none">
        {
          // project.data.page ? (
          //   <a
          //     href={project.data.page}
          //     class="flex items-center !rounded-lg border-2 border-neutral-500 px-2 py-1.5 leading-none text-neutral-700 !ring-neutral-500 transition hover:border-neutral-700 hover:text-neutral-900 dark:border-neutral-500 dark:text-neutral-300 dark:hover:border-neutral-100 dark:hover:text-neutral-50 dark:hover:!ring-neutral-100 dark:active:border-neutral-100 dark:active:text-neutral-50 dark:active:!ring-neutral-100"
          //   >
          //     <BookOpenTextIcon className="mr-1.5 size-5" aria-hidden="true" />
          //     {project.data.pageButton || 'View Page'}
          //   </a>
          // ) : (
          project.data.source &&
            (project.data.source === 'closed' ? (
              <button
                disabled
                aria-disabled="true"
                class="flex cursor-not-allowed items-center py-1.5 pr-2 leading-none font-medium disabled:opacity-80"
              >
                <LockIcon className="mr-1.5 size-5" aria-hidden="true" />
                <div>Closed Source</div>
              </button>
            ) : (
              <ProjectLink href={project.data.source} external>
                <CodeIcon className="mr-1.5 size-5" aria-hidden="true" />
                Source Code
              </ProjectLink>
            ))
        }
        {project.data.article && (
          <ProjectLink href={project.data.article}>
            <BookOpenTextIcon className="mr-1.5 size-5" aria-hidden="true" />
            Read More
          </ProjectLink>
        )}
        {project.data.demo && (
          <ProjectLink href={project.data.demo} external>
            <LinkIcon className="mr-1.5 size-5" aria-hidden="true" />
            Demo
          </ProjectLink>
        )}
        {project.data.play && (
          <ProjectLink href={project.data.play} external>
            <GamepadIcon className="mr-1.5 size-5" aria-hidden="true" />
            Play
          </ProjectLink>
        )}
        {project.data.download && (
          <ProjectLink href={project.data.download} external>
            <ExternalLinkIcon className="mr-1.5 size-5" aria-hidden="true" />
            Download
          </ProjectLink>
        )}
        {project.data.apple && (
          <ProjectLink
            href="https://apps.apple.com/ca/app/pollution-reporter/id1476589861"
            external
          >
            <AppleIcon className="mr-1.5 size-5" aria-hidden="true" />
            App Store
          </ProjectLink>
        )}
        {project.data.google && (
          <ProjectLink
            href="https://play.google.com/store/apps/details?id=com.PollutionReporter"
            external
          >
            <BotIcon className="mr-1.5 size-5" aria-hidden="true" />
            Play Store
          </ProjectLink>
        )}
      </div>
    )
  }
</div>
